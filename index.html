// بارگذاری و پردازش داده‌ها با PapaParse
Papa.parse(csvUrl, {
    download: true,
    header: true,
    complete: function(results) {
        results.data.forEach(function(row) {
            var lat = parseFloat(row["Latitude"]);
            var lon = parseFloat(row["Longitude"]);
            var checked = row["پرسشنامه تکمیل شد"] === "TRUE";
            var overuseWater = parseFloat(row["درصد اضافه برداشت آب"]);
            var overuseElectricity = parseFloat(row["درصد اضافه برداشت برق"]);
            var wellID = row["کد کلاسه"];

            if (!isNaN(lat) && !isNaN(lon)) {
                var triangleIcon, circleIcon;

                // تنظیم مارکر مثلثی
                if (overuseWater > 42.5 && overuseElectricity > 42.5) {
                    triangleIcon = L.divIcon({
                        className: 'triangle-marker',
                        html: `<div style="border-bottom: 14px solid red;"></div>`,
                        iconSize: [10, 10]
                    });
                } else if (overuseWater > 20 || overuseElectricity > 20) {
                    triangleIcon = L.divIcon({
                        className: 'triangle-marker',
                        html: `<div style="border-bottom: 14px solid orange;"></div>`,
                        iconSize: [10, 10]
                    });
                } else if (overuseWater > 5 || overuseElectricity > 5) {
                    triangleIcon = L.divIcon({
                        className: 'triangle-marker',
                        html: `<div style="border-bottom: 14px solid yellow;"></div>`,
                        iconSize: [10, 10]
                    });
                } else {
                    triangleIcon = L.divIcon({
                        className: 'triangle-marker',
                        html: `<div style="border-bottom: 14px solid green;"></div>`,
                        iconSize: [10, 10]
                    });
                }

                // تنظیم مارکر دایره‌ای
                if (checked) {
                    circleIcon = L.divIcon({
                        className: 'marker-circle flashing-circle',
                        iconSize: [12, 12]
                    });
                } else {
                    circleIcon = L.divIcon({
                        className: 'marker-circle',
                        iconSize: [3, 3]
                    });
                }

                // اضافه کردن مارکر مثلثی
                var triangleMarker = L.marker([lat, lon], { icon: triangleIcon }).addTo(map)
                    .bindPopup(`
                        <b>Well ID:</b> ${wellID}<br>
                        <b>Water Overuse:</b> ${overuseWater}%<br>
                        <b>Electricity Overuse:</b> ${overuseElectricity}%
                    `);
                
                // اضافه کردن ویژگی به مارکر
                triangleMarker.wellID = wellID;

                // اضافه کردن مارکر دایره‌ای
                var circleMarker = L.marker([lat, lon], { icon: circleIcon }).addTo(map)
                    .bindPopup(`
                        <b>Well ID:</b> ${wellID}<br>
                        <b>Water Overuse:</b> ${overuseWater}%<br>
                        <b>Electricity Overuse:</b> ${overuseElectricity}%
                    `);
                
                // اضافه کردن ویژگی به مارکر
                circleMarker.wellID = wellID;

                // ذخیره مارکرها در آرایه
                markers.push(triangleMarker);
                markers.push(circleMarker);
            }
        });
    }
});

// جستجو برای یافتن چاه با کد مشخص
function searchWell() {
    var searchQuery = document.getElementById("well-id-search").value.toUpperCase();
    var found = false;

    markers.forEach(function(marker) {
        if (marker.wellID && marker.wellID.toUpperCase().includes(searchQuery)) {
            map.setView(marker.getLatLng(), 15); // بزرگ‌نمایی به مارکر
            marker.openPopup(); // باز کردن پاپ‌آپ
            found = true;
        }
    });

    if (!found) {
        alert("چاه مورد نظر یافت نشد.");
    }
}
