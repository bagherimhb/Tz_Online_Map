<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>هم‌بست آب-انرژی-محیط زیست آبخوان</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* تنظیمات استایل */
#map { width: 100%; height: 70vh; margin: 0; padding: 0; }
#chartContainer { width: 100%; height: 30vh; }
.marker-circle { width: 6px; height: 6px; border-radius: 50%; background-color: blue; transform: translate(-50%, -50%); }
.flashing-circle { animation: flash 1s infinite; }
@keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.1; } 100% { opacity: 1; } }
.legend { bottom: 60px; line-height: 18px; color: #555; background-color: white; padding: 6px 8px; border-radius: 5px; }
.legend i { width: 14px; height: 14px; float: left; margin-right: 8px; opacity: 0.9; }
</style>
</head>
<body>

<div id="search-container">
    <input type="text" id="search-input" placeholder="برای جستجو، کلاسه چاه وارد نمایید" />
    <button id="search-button">Search</button>
    <button id="clear-button">Clear</button>
</div>
<div id="map"></div>
<div id="chartContainer">
    <canvas id="evaporationChart"></canvas>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    var map = L.map('map', { center: [31.052, 53.2621], zoom: 11 });

    // افزودن لایه‌های نقشه
    var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
    var satelliteLayer = L.tileLayer('https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=YOUR_MAPTILER_KEY', { maxZoom: 19 });
    L.control.layers({ "OSM": osmLayer, "Satellite": satelliteLayer }).addTo(map);

    // افزودن داده‌ها
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSge8iyIvBomiIgCEQIv1ctR2Wgll3aGclzzgkbBiJCWE5wgRCE41KDq0uUUU8l0X8IbxDqIFvVlEa0/pub?gid=0&single=true&output=csv";

    Papa.parse(csvUrl, {
        download: true,
        header: true,
        complete: function (results) {
            let data = results.data.map(row => ({
                lat: parseFloat(row["Latitude"]),
                lon: parseFloat(row["Longitude"]),
                overuseWater: parseFloat(row["درصد اضافه برداشت آب"]),
                overuseElectricity: parseFloat(row["درصد اضافه برداشت برق"]),
                questionnaireCompleted: row["پرسشنامه تکمیل شد"] === "TRUE",
                wellID: row["کد کلاسه"]
            })).filter(d => !isNaN(d.lat) && !isNaN(d.lon));

            // افزودن مارکرها
            data.forEach(item => {
                let color = item.overuseWater > 50 ? "red" : item.overuseWater > 30 ? "orange" : item.overuseWater > 10 ? "yellow" : "green";

                let circleIcon = L.divIcon({
                    className: item.questionnaireCompleted ? 'marker-circle flashing-circle' : 'marker-circle',
                    iconSize: [12, 12]
                });

                L.marker([item.lat, item.lon], { icon: circleIcon }).addTo(map)
                    .bindPopup(`<b>Well ID:</b> ${item.wellID}<br><b>Overuse:</b> ${item.overuseWater}%`);
            });
        }
    });

    // ابزار رسم پلیگون
    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    var drawControl = new L.Control.Draw({
        edit: { featureGroup: drawnItems },
        draw: { polygon: true, polyline: false, rectangle: false, circle: false, marker: false }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, function (e) {
        var layer = e.layer;
        drawnItems.addLayer(layer);

        // مختصات پلیگون رسم‌شده
        var coordinates = layer.getLatLngs();

        // شبیه‌سازی دریافت داده‌های تبخیر و تعرق
        fetchEvaporationData(coordinates).then(data => {
            updateChart(data.labels, data.values);
        });
    });

    // دریافت داده‌های تبخیر و تعرق
    async function fetchEvaporationData(coords) {
        const years = Array.from({ length: 2023 - 2010 + 1 }, (_, i) => 2010 + i);
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const labels = years.flatMap(year => months.map(month => `${month} ${year}`));
        const values = labels.map(() => (Math.random() * 100).toFixed(2));
        return { labels, values };
    }

    // افزودن نمودار
    var ctx = document.getElementById('evaporationChart').getContext('2d');
    var evaporationChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'تبخیر و تعرق واقعی (میلیمتر)',
                data: [],
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: { title: { display: true, text: 'زمان' } },
                y: { beginAtZero: true, title: { display: true, text: 'تبخیر و تعرق (میلیمتر)' } }
            }
        }
    });

    // به‌روزرسانی نمودار
    function updateChart(labels, values) {
        evaporationChart.data.labels = labels;
        evaporationChart.data.datasets[0].data = values;
        evaporationChart.update();
    }
});
</script>

</body>
</html>
