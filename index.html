<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>هم‌بست آب-انرژی-محیط زیست آبخوان</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* تنظیمات استایل همانند نسخه قبلی */
#map { width: 100%; height: 70vh; }
#chartContainer { width: 100%; height: 30vh; }
.legend { /* سایر استایل‌ها */ }
/* بقیه استایل‌ها تغییر نکرده‌اند */
</style>
</head>
<body>

<div id="search-container">
    <input type="text" id="search-input" placeholder="برای جستجو، کلاسه چاه وارد نمایید" />
    <button id="search-button">Search</button>
    <button id="clear-button">Clear</button>
</div>
<div id="map"></div>
<div id="chartContainer">
    <canvas id="evaporationChart"></canvas>
</div>
<img id="logo" src="images/waterCo_university.png" alt="Logo" />

<script>
document.addEventListener('DOMContentLoaded', function () {
    var map = L.map('map', { center: [31.052, 53.2621], zoom: 11 });

    var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Developer: MH Bagheri'
    }).addTo(map);

    // افزودن کنترل‌های رسم
    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    var drawControl = new L.Control.Draw({
        edit: { featureGroup: drawnItems },
        draw: { polygon: true, polyline: false, rectangle: false, circle: false, marker: false }
    });
    map.addControl(drawControl);

    // ایجاد نقشه و داده‌های اولیه
    shp("shape_files/Aquifer_.zip").then(function (geojson) {
        L.geoJSON(geojson, { style: { fillColor: 'blue', weight: 2 } }).addTo(map);
    });

    // تعریف رویداد رسم پلیگون
    map.on(L.Draw.Event.CREATED, function (e) {
        var layer = e.layer;
        drawnItems.addLayer(layer);

        var coordinates = layer.getLatLngs();
        console.log('Polygon Coordinates:', coordinates);

        // دریافت داده‌های تبخیر و تعرق
        fetchEvaporationData(coordinates).then(data => {
            updateChart(data.labels, data.values);
        });
    });

    // مثال داده‌های تبخیر و تعرق ماهانه
    async function fetchEvaporationData(coords) {
        const years = Array.from({ length: 2023 - 2010 + 1 }, (_, i) => 2010 + i);
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const labels = years.flatMap(year => months.map(month => `${month} ${year}`));
        const values = labels.map(() => (Math.random() * 100).toFixed(2));
        return { labels, values };
    }

    // افزودن نمودار Chart.js
    var ctx = document.getElementById('evaporationChart').getContext('2d');
    var evaporationChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Monthly Evaporation (mm)',
                data: [],
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: { title: { display: true, text: 'Time' } },
                y: { beginAtZero: true, title: { display: true, text: 'Evaporation (mm)' } }
            }
        }
    });

    // به‌روزرسانی داده‌های نمودار
    function updateChart(labels, values) {
        evaporationChart.data.labels = labels;
        evaporationChart.data.datasets[0].data = values;
        evaporationChart.update();
    }

    // بقیه اسکریپت اصلی تغییر نکرده‌اند
});
</script>
</body>
</html>
