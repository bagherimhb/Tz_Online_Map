<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Well Map with Custom MapTiler Layer</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://unpkg.com/shpjs@3.4.0/dist/shp.min.js"></script>
<style>
@keyframes flash {
0% { opacity: 1; }
50% { opacity: 0.3; }
100% { opacity: 1; }
}
.flashing-marker {
animation: flash 1s infinite;
}
#map {
width: 100%;
height: 600px;
}
.triangle-marker {
width: 0;
height: 0;
border-left: 7px solid transparent;
border-right: 7px solid transparent;
border-bottom: 14px solid;
position: absolute;
transform: translate(-50%, -50%);
z-index: 0; /* مثلث‌ها زیر دایره‌ها قرار می‌گیرند */
}
.marker-circle {
width: 6px;
height: 6px;
border-radius: 50%;
background-color: blue;
position: absolute;
transform: translate(-50%, -50%);
z-index: 1; /* دایره‌ها بالاتر از مثلث‌ها قرار می‌گیرند */
}
.flashing-circle {
animation: flash 1s infinite;
}
</style>
</head>
<body>
<div id="map"></div>
<script>
var mapTilerKey = 'otxQEa1xT4DzKWLSdyS7';

// ایجاد نقشه و تنظیمات اولیه
var map = L.map('map', {
center: [31.052, 53.2621],
zoom: 10
});

// افزودن لایه OSM
var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
maxZoom: 19,
attribution: '© OpenStreetMap contributors'
});

// افزودن لایه ماهواره‌ای MapTiler
var mapTilerSatLayer = L.tileLayer('https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=' + mapTilerKey, {
tileSize: 512,
zoomOffset: -1,
minZoom: 1,
maxZoom: 19,
attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',
crossOrigin: true
}).addTo(map); // افزودن لایه ماهواره‌ای به عنوان لایه پیش‌فرض

// افزودن لایه‌های نقشه به عنوان گزینه‌های انتخابی
var baseLayers = {
"OSM": osmLayer,
"Satellite": mapTilerSatLayer
};

// کنترل لایه‌ها را به نقشه اضافه کنید
L.control.layers(baseLayers).addTo(map);

// لینک CSV داده‌های Google Sheets
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSge8iyIvBomiIgCEQIv1ctR2Wgll3aGclzzgkbBiJCWE5wgRCE41KDq0uUUU8l0X8IbxDqIFvVlEa0/pub?gid=0&single=true&output=csv";

// بارگذاری و پردازش داده‌ها با PapaParse
Papa.parse(csvUrl, {
download: true,
header: true,
complete: function(results) {
results.data.forEach(function(row) {
var lat = parseFloat(row["Latitude"]);
var lon = parseFloat(row["Longitude"]);
var checked = row["پرسشنامه تکمیل شد"] === "TRUE";
var overuseWater = parseFloat(row["درصد اضافه برداشت آب"]);
var overuseElectricity = parseFloat(row["درصد اضافه برداشت برق"]);

if (!isNaN(lat) && !isNaN(lon)) {
    var triangleIcon;
    var circleIcon;
    
    // تنظیم مارکر مثلثی
    if (overuseWater > 50 && overuseElectricity > 50) {
        triangleIcon = L.divIcon({
            className: 'triangle-marker',
            html: `<div style="border-bottom-color: red;"></div>`,
            iconSize: [14, 14]
        });
    } else if (overuseWater > 30 || overuseElectricity > 30) {
        triangleIcon = L.divIcon({
            className: 'triangle-marker',
            html: `<div style="border-bottom-color: orange;"></div>`,
            iconSize: [14, 14]
        });
    } else if (overuseWater > 10 || overuseElectricity > 10) {
        triangleIcon = L.divIcon({
            className: 'triangle-marker',
            html: `<div style="border-bottom-color: yellow;"></div>`,
            iconSize: [14, 14]
        });
    } else {
        triangleIcon = L.divIcon({
            className: 'triangle-marker',
            html: `<div style="border-bottom-color: green;"></div>`,
            iconSize: [14, 14]
        });
    }

    // تنظیم مارکر دایره‌ای (با رنگ آبی و حالت فلاشر در صورت تکمیل پرسشنامه)
    if (checked) {
        circleIcon = L.divIcon({
            className: 'marker-circle flashing-circle', // دایره آبی و حالت فلاشر
            iconSize: [6, 6]
        });
    } else {
        circleIcon = L.divIcon({
            className: 'marker-circle',
            iconSize: [6, 6]
        });
    }

    // اضافه کردن مارکر مثلثی
    L.marker([lat, lon], { icon: triangleIcon }).addTo(map).bindPopup(`
    <b>Well ID:</b> ${row["کد کلاسه"]}<br>
    <b>Water Overuse:</b> ${overuseWater}%<br>
    <b>Electricity Overuse:</b> ${overuseElectricity}%
    `);

    // اضافه کردن مارکر دایره‌ای (با فلاشر در صورت تکمیل پرسشنامه)
    L.marker([lat, lon], { icon: circleIcon }).addTo(map).bindPopup(`
    <b>Well ID:</b> ${row["کد کلاسه"]}<br>
    <b>Water Overuse:</b> ${overuseWater}%<br>
    <b>Electricity Overuse:</b> ${overuseElectricity}%
    `);
}
});
},
error: function(error) {
console.error("Error parsing CSV:", error);
}
});

// بارگذاری و افزودن لایه Shapefile
shp("shape_files/Aquifer_.zip").then(function(geojson) {
  L.geoJSON(geojson, {
    style: function() {
      return {
        color: "#3388ff", // رنگ لایه
        opacity: 0.25,     // شفافیت لایه
        fillOpacity: 0.25  // شفافیت داخل پلیگون‌ها (در صورت وجود)
      };
    }
  }).addTo(map);
}).catch(function(error) {
  console.error("Error loading shapefile:", error);
});
</script>
</body>
</html>
