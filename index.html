<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>هم‌بست آب-انرژی-محیط زیست آبخوان</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
#map {
    height: 100%;
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100vh;
}
.marker-circle {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: blue;
    position: absolute;
    transform: translate(-50%, -50%);
    z-index: 1;
}
.flashing-circle {
    animation: flash 1s infinite;
}
@keyframes flash {
    0% { opacity: 1; }
    50% { opacity: 0.1; }
    100% { opacity: 1; }
}
.legend {
    bottom: 60px;
    line-height: 18px;
    color: #555;
    background-color: white;
    padding: 6px 8px;
    border-radius: 5px;
}
.legend i {
    width: 14px;
    height: 14px;
    float: left;
    margin-right: 8px;
    opacity: 0.9;
}
#chart-container {
    position: absolute;
    top: 10px;
    left: 10px;
    width: 400px;
    height: 300px;
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 10px;
    display: none; /* پنهان تا زمانی که پلیگون انتخاب نشده باشد */
    z-index: 1003;
}
</style>
</head>
<body>

<div id="map"></div>
<div id="chart-container">
    <canvas id="chart"></canvas>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    var map = L.map('map', {
        center: [31.052, 53.2621],
        zoom: 11
    });

    var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Developer: MH Bagheri'
    }).addTo(map);

    // لایه ماهواره‌ای
    var satelliteLayer = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; OpenStreetMap contributors'
    });

    L.control.layers({ "OSM": osmLayer, "Satellite": satelliteLayer }).addTo(map);

    // لایه Shape
    shp("shape_files/Aquifer_.zip").then(function (geojson) {
        L.geoJSON(geojson, {
            style: function () {
                return { color: 'blue', weight: 2, fillOpacity: 0.1 };
            }
        }).addTo(map);
    });

    // داده تبخیر و تعرق فرضی
    var evapotranspirationData = {
        "2010": [2, 4, 3, 5, 6, 7, 4, 5, 8, 9, 6, 7],
        "2023": [3, 5, 4, 6, 8, 9, 5, 6, 10, 11, 8, 9]
    };

    // قابلیت رسم پلیگون
    var drawnPolygon;
    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    var drawControl = new L.Control.Draw({
        edit: { featureGroup: drawnItems },
        draw: { rectangle: false, circle: false, marker: false, circlemarker: false }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, function (event) {
        var layer = event.layer;

        // پاک کردن پلیگون قبلی
        if (drawnPolygon) {
            map.removeLayer(drawnPolygon);
        }
        drawnPolygon = layer;
        drawnItems.addLayer(layer);

        // نمایش نمودار
        displayChart(evapotranspirationData);
    });

    function displayChart(data) {
        var years = Object.keys(data);
        var datasets = years.map(year => ({
            label: `Year ${year}`,
            data: data[year],
            backgroundColor: year === "2010" ? 'rgba(75, 192, 192, 0.6)' : 'rgba(153, 102, 255, 0.6)'
        }));

        var ctx = document.getElementById('chart').getContext('2d');
        if (window.myChart) window.myChart.destroy(); // بازنشانی نمودار قدیمی

        window.myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: datasets
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        document.getElementById('chart-container').style.display = 'block';
    }
});
</script>
</body>
</html>
