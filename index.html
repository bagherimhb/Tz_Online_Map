<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Well Map with Custom MapTiler Layer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://unpkg.com/shpjs@3.4.0/dist/shp.min.js"></script>
  <style>
    @keyframes flash {
      0% { opacity: 1; }
      50% { opacity: 0.1; }
      100% { opacity: 1; }
    }
    .flashing-marker {
      animation: flash 1s infinite;
    }
    #map {
      width: 100%;
      height: 600px;
    }
    .triangle-marker {
      width: 0;
      height: 0;
      border-left: 7px solid transparent;
      border-right: 7px solid transparent;
      position: absolute;
      transform: translate(-50%, -50%);
      z-index: 0;
    }
    .marker-circle {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: blue;
      position: absolute;
      transform: translate(-50%, -50%);
      z-index: 1;
    }
    .flashing-circle {
      animation: flash 1s infinite;
    }
    #search-container {
      margin: 10px;
      padding: 5px;
    }
    #well-id-search {
      width: 250px;
      height: 30px;
      padding: 5px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin-right: 10px;
    }
    #search-container button {
      height: 40px;
      padding: 0 15px;
      font-size: 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #search-container button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>

<!-- بخش جستجو -->
<div id="search-container">
  <input type="text" id="well-id-search" placeholder="برای جستجوی چاه، کلاسه را وارد نمائید" />
  <button onclick="searchWell()">Search</button>
</div>

<!-- نقشه -->
<div id="map"></div>

<script>
// تعریف کلید MapTiler
var mapTilerKey = 'otxQEa1xT4DzKWLSdyS7';

// ایجاد نقشه و تنظیمات اولیه
var map = L.map('map', {
  center: [31.052, 53.2621],
  zoom: 10
});

// افزودن لایه OSM
var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: 'Developer: MH Bagheri '
});

// افزودن لایه ماهواره‌ای MapTiler
var mapTilerSatLayer = L.tileLayer('https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=' + mapTilerKey, {
  tileSize: 512,
  zoomOffset: -1,
  minZoom: 1,
  maxZoom: 19,
  attribution: 'Developer: MH Bagheri ',
  crossOrigin: true
}).addTo(map);

// افزودن لایه‌های نقشه به عنوان گزینه‌های انتخابی
var baseLayers = {
  "OSM": osmLayer,
  "Satellite": mapTilerSatLayer
};

// کنترل لایه‌ها را به نقشه اضافه کنید
L.control.layers(baseLayers).addTo(map);

// لینک CSV داده‌های Google Sheets
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSge8iyIvBomiIgCEQIv1ctR2Wgll3aGclzzgkbBiJCWE5wgRCE41KDq0uUUU8l0X8IbxDqIFvVlEa0/pub?gid=0&single=true&output=csv";

// تعریف آرایه‌ای برای ذخیره مارکرها
var markers = [];

// بارگذاری و پردازش داده‌ها با PapaParse
Papa.parse(csvUrl, {
  download: true,
  header: true,
  complete: function(results) {
    results.data.forEach(function(row) {
      var lat = parseFloat(row["Latitude"]);
      var lon = parseFloat(row["Longitude"]);
      var wellID = row["کد کلاسه"];

      if (!isNaN(lat) && !isNaN(lon)) {
        var marker = L.marker([lat, lon]).addTo(map)
          .bindPopup(`<b>Well ID:</b> ${wellID}`);
        
        markers.push({ marker: marker, wellID: wellID });
      }
    });
  },
  error: function(error) {
    console.error("Error parsing CSV:", error);
  }
});

// جستجو بر اساس WELL ID و زوم به آن نقطه
function searchWell() {
  var searchTerm = document.getElementById("well-id-search").value.toUpperCase();
  markers.forEach(function(markerObj) {
    var markerWellID = markerObj.wellID.toUpperCase();
    if (markerWellID.indexOf(searchTerm) > -1) {
      markerObj.marker.addTo(map); // نمایش مارکر
      map.setView(markerObj.marker.getLatLng(), 14); // زوم به موقعیت مارکر
    } else {
      map.removeLayer(markerObj.marker); // مخفی کردن مارکر
    }
  });
}
</script>

</body>
</html>
